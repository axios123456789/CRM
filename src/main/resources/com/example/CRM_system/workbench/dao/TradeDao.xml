<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.CRM_system.workbench.dao.TradeDao">
<!--条件查询交易列表-->
    <select id="getTradeListByCondition" resultType="com.example.CRM_system.workbench.pojo.Trade">
        select

        t.id,
        u.name as owner,
        t.name,
        t.stage,
        t.type,
        t.source,
        ctr.name as customerId,
        ctt.name as contactId

        from c_trade t
        join c_user u on t.owner = u.id
        join c_customer ctr on t.customerId = ctr.id
        join c_contact ctt on t.contactId = ctt.id

        <where>
            <if test="name != null and name != ''">
                and t.name like concat('%', #{name}, '%')
            </if>
            <if test="owner != null and owner != ''">
                and u.name like concat('%', #{owner}, '%')
            </if>
            <if test="customerName != null and customerName != ''">
                and ctr.name like concat('%', #{customerName}, '%')
            </if>
            <if test="stage != null and stage != ''">
                and t.stage like concat('%', #{stage}, '%')
            </if>
            <if test="type != null and type != ''">
                and t.type like concat('%', #{type}, '%')
            </if>
            <if test="source != null and source != ''">
                and t.source like concat('%', #{source}, '%')
            </if>
            <if test="contactName != null and contactName != null">
                and ctt.name like concat('%', #{contactName}, '%')
            </if>
        </where>

        order by t.createTime desc

        limit #{skipCount}, #{pageSize}
    </select>

<!--    条件查询交易的记录数-->
    <select id="getTradeCountByCondition" resultType="java.lang.Integer">
        select count(*)

        from c_trade t
        join c_user u on t.owner = u.id
        join c_customer ctr on t.customerId = ctr.id
        join c_contact ctt on t.contactId = ctt.id

        <where>
            <if test="name != null and name != ''">
                and t.name like concat('%', #{name}, '%')
            </if>
            <if test="owner != null and owner != ''">
                and u.name like concat('%', #{owner}, '%')
            </if>
            <if test="customerName != null and customerName != ''">
                and ctr.name like concat('%', #{customerName}, '%')
            </if>
            <if test="stage != null and stage != ''">
                and t.stage like concat('%', #{stage}, '%')
            </if>
            <if test="type != null and type != ''">
                and t.type like concat('%', #{type}, '%')
            </if>
            <if test="source != null and source != ''">
                and t.source like concat('%', #{source}, '%')
            </if>
            <if test="contactName != null and contactName != null">
                and ctt.name like concat('%', #{contactName}, '%')
            </if>
        </where>
    </select>
</mapper>